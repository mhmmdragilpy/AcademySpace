@startuml EXT-Mereset_Password

title Sequence Diagram: EXT Mereset Password

' ============================================
' DAFTAR AKTOR DAN OBJEK (LIFELINE)
' ============================================
' Aktor:
'   - User: Pengguna yang lupa password
' Objek:
'   - LoginPage: Halaman login (Boundary)
'   - ForgotPasswordPage: Halaman forgot password (Boundary)
'   - AuthController: Controller autentikasi
'   - UserDB: Database user (Entity)
'   - TokenDB: Database token (Entity)

actor "User" as User

boundary "LoginPage" as LogPage
boundary "ForgotPasswordPage" as ForgotPage
control "AuthController" as AuthCtrl
entity "UserDB" as UserDB
entity "TokenDB" as TokenDB

' ============================================
' SKENARIO: MERESET PASSWORD
' ============================================
== Mereset Password ==

User -> LogPage: Akses halaman login
activate LogPage

User -> LogPage: Klik "Forgot password?"

LogPage -> ForgotPage: navigate("/forgot-password")
activate ForgotPage
deactivate LogPage

ForgotPage --> User: Tampilkan form forgot password\n(Username, Master Token, New Password, Confirm Password)

User -> ForgotPage: Isi semua field:
note right of User
  - Username
  - Password Reset Master Token (dari Admin)
  - New Password
  - Confirm New Password
end note

User -> ForgotPage: Klik "Reset Password"

ForgotPage -> AuthCtrl: resetPassword(username, masterToken, newPassword, confirmPassword)
activate AuthCtrl

' Validasi password match
alt New Password != Confirm Password
    AuthCtrl --> ForgotPage: error("Passwords do not match")
    ForgotPage --> User: Tampilkan pesan error
else Passwords match
    ' Validasi Master Token
    AuthCtrl -> TokenDB: validateToken("PASSWORD_RESET", masterToken)
    activate TokenDB
    TokenDB --> AuthCtrl: isValid: boolean
    deactivate TokenDB
    
    alt Token tidak valid
        AuthCtrl --> ForgotPage: error("Invalid master token")
        ForgotPage --> User: Tampilkan pesan error
    else Token valid
        ' Cari user berdasarkan username
        AuthCtrl -> UserDB: findByUsername(username)
        activate UserDB
        UserDB --> AuthCtrl: userData
        deactivate UserDB
        
        alt User tidak ditemukan
            AuthCtrl --> ForgotPage: error("User not found")
            ForgotPage --> User: Tampilkan pesan error
        else User ditemukan
            ' Hash password baru
            AuthCtrl -> AuthCtrl: hashPassword(newPassword)
            
            ' Update password
            AuthCtrl -> UserDB: updatePassword(userId, hashedPassword)
            activate UserDB
            UserDB --> AuthCtrl: updated
            deactivate UserDB
            
            AuthCtrl --> ForgotPage: success("Password reset successfully")
            deactivate AuthCtrl
            
            ForgotPage --> User: Tampilkan notifikasi sukses\n"Password has been reset"
            
            ForgotPage -> LogPage: redirect("/login")
            activate LogPage
            LogPage --> User: Tampilkan halaman login\ndengan pesan sukses
            deactivate LogPage
            deactivate ForgotPage
        end
    end
end

note over User, TokenDB
  Catatan:
  - Password Reset Master Token didapat dari Admin
  - Admin dapat menyalin token dari halaman System Tokens
  - Token ini bersifat rahasia dan hanya diberikan
    kepada user yang membutuhkan reset password
end note

@enduml
